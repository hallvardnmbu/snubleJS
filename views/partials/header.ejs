<div class="header">
  <div><%= visitors %> besøkende denne måneden.</div>
  <% if (!user) { %>
    <button onclick="openLoginModal()">
      Logg inn / Registrer
    </button>
  <% } else { %>
    <button onclick="window.location.href='/profile'">
      <%= user.username %>
    </button>
  <% } %>
</div>

<div id="loginModal" class="modal">
  <div class="heading">
    <div>
      Logg inn / Registrer
    </div>
    <div class="close" id="closeLogin">x</div>
  </div>

  <div id="loginMessage"></div>
  <form id="loginForm">
    <div class="form-group">
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required>
    </div>
    <div class="form-group">
      <label for="username">Brukernavn:</label>
      <input type="text" id="username" name="username" required>
    </div>
    <div class="form-group">
      <label for="password">Passord:</label>
      <input type="password" id="password" name="password" required>
    </div>
    <button type="submit">Logg inn</button>
  </form>
</div>

<script>
const modal = document.getElementById("loginModal");
const closeBtn = document.getElementById("closeLogin");
const loginForm = document.getElementById("loginForm");
const loginMessage = document.getElementById("loginMessage");

function openLoginModal() {
  modal.style.display = "block";
}

closeBtn.onclick = function() {
  modal.style.display = "none";
}

window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}

loginForm.onsubmit = async function(e) {
  e.preventDefault();

  const formData = {
    email: document.getElementById("email").value,
    username: document.getElementById("username").value,
    password: document.getElementById("password").value
  };

  try {
    const response = await fetch('/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formData)
    });

    const data = await response.json();

    if (response.ok) {
      loginMessage.className = 'success';
      loginMessage.textContent = 'Innlogging vellykket!';

      // Store the token
      localStorage.setItem('token', data.token);

      // Reload the page after successful login
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } else {
      loginMessage.className = 'error';
      loginMessage.textContent = data.message || 'Innlogging mislyktes';
    }
  } catch (error) {
    loginMessage.className = 'error';
    loginMessage.textContent = 'En feil oppstod. Vennligst prøv igjen.';
  }
};
</script>
